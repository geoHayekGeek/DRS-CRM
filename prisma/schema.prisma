generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  ADMIN
}

model AdminUser {
  id           String   @id @default(uuid())
  email        String   @unique
  name         String?
  passwordHash String   @map("password_hash")
  role         Role     @default(ADMIN)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("admin_users")
}

model Driver {
  id               String           @id @default(uuid())
  fullName         String           @map("full_name")
  profileImageUrl  String?          @map("profile_image_url")
  weight           Float?
  height           Float?
  notes            String?
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  roundDrivers           RoundDriver[]
  groupAssignments       GroupAssignment[]
  sessionResults         SessionResult[]
  pointAdjustments       DriverPointAdjustment[]
  standingsOverrides     StandingsOverride[]

  @@map("drivers")
}

model Track {
  id              String       @id @default(uuid())
  name            String
  lengthMeters    Float        @map("length_meters")
  location        String?
  layoutImageUrl  String?      @map("layout_image_url")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  rounds          Round[]
  trackImages     TrackImage[]

  @@map("tracks")
}

model TrackImage {
  id        String   @id @default(uuid())
  trackId   String   @map("track_id")
  track     Track    @relation(fields: [trackId], references: [id], onDelete: Cascade)
  imageUrl  String   @map("image_url")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("track_images")
}

model Championship {
  id                String              @id @default(uuid())
  name              String
  isCurrent         Boolean             @default(false) @map("is_current")
  startDate         DateTime            @map("start_date")
  endDate           DateTime?           @map("end_date")
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")
  rounds            Round[]
  pointAdjustments  DriverPointAdjustment[]
  standingsOverrides StandingsOverride[]

  @@map("championships")
}

model Round {
  id               String            @id @default(uuid())
  name             String
  date             DateTime
  trackId          String            @map("track_id")
  track            Track             @relation(fields: [trackId], references: [id], onDelete: Cascade)
  championshipId   String?           @map("championship_id")
  championship     Championship?     @relation(fields: [championshipId], references: [id], onDelete: Cascade)
  numberOfGroups   Int               @default(4) @map("number_of_groups")
  availableKarts   Int[]             @default([]) @map("available_karts")
  setupCompleted   Boolean           @default(false) @map("setup_completed")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  sessions         Session[]
  roundDrivers       RoundDriver[]
  groupAssignments   GroupAssignment[]
  roundImages        RoundImage[]
  pointAdjustments   DriverPointAdjustment[]

  @@map("rounds")
}

model RoundDriver {
  id        String   @id @default(uuid())
  roundId   String   @map("round_id")
  round     Round    @relation(fields: [roundId], references: [id], onDelete: Cascade)
  driverId  String   @map("driver_id")
  driver    Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([roundId, driverId])
  @@map("round_drivers")
}

model RoundImage {
  id        String   @id @default(uuid())
  roundId   String   @map("round_id")
  round     Round    @relation(fields: [roundId], references: [id], onDelete: Cascade)
  imageUrl  String   @map("image_url")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("round_images")
}

enum SessionType {
  QUALIFYING
  RACE
  FINAL_QUALIFYING
  FINAL_RACE
}

enum PointsMultiplier {
  NORMAL
  HALF
  DOUBLE
}

enum SessionStatus {
  PENDING
  READY
  COMPLETED
}

model Session {
  id               String          @id @default(uuid())
  roundId          String          @map("round_id")
  round            Round           @relation(fields: [roundId], references: [id], onDelete: Cascade)
  type             SessionType
  group            String?
  order            Int
  status           SessionStatus   @default(READY) @map("status")
  pointsMultiplier PointsMultiplier? @map("points_multiplier")
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")
  results          SessionResult[]

  @@map("sessions")
}

model SessionResult {
  id        String   @id @default(uuid())
  sessionId String   @map("session_id")
  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  driverId  String   @map("driver_id")
  driver    Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  position  Int
  points    Float
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([sessionId, driverId])
  @@map("session_results")
}

model GroupAssignment {
  id         String   @id @default(uuid())
  roundId    String   @map("round_id")
  round      Round    @relation(fields: [roundId], references: [id], onDelete: Cascade)
  driverId   String   @map("driver_id")
  driver     Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  group      String
  kartNumber Int      @map("kart_number")
  createdAt  DateTime @default(now()) @map("created_at")

  @@unique([roundId, driverId])
  @@map("group_assignments")
}

model DriverPointAdjustment {
  id             String         @id @default(uuid())
  driverId       String         @map("driver_id")
  driver         Driver         @relation(fields: [driverId], references: [id], onDelete: Cascade)
  roundId        String?        @map("round_id")
  round          Round?         @relation(fields: [roundId], references: [id], onDelete: Cascade)
  championshipId String?        @map("championship_id")
  championship   Championship?  @relation(fields: [championshipId], references: [id], onDelete: Cascade)
  delta          Int
  reason         String?
  createdAt      DateTime       @default(now()) @map("created_at")

  @@map("driver_point_adjustments")
}

model StandingsOverride {
  id             String        @id @default(uuid())
  championshipId String        @map("championship_id")
  championship   Championship  @relation(fields: [championshipId], references: [id], onDelete: Cascade)
  driverId       String        @map("driver_id")
  driver         Driver        @relation(fields: [driverId], references: [id], onDelete: Cascade)
  tieKey         String        @map("tie_key")
  orderIndex     Int           @map("order_index")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  @@unique([championshipId, driverId, tieKey])
  @@map("standings_overrides")
}

model Event {
  id          String       @id @default(uuid())
  title       String       @db.VarChar(120)
  description String?
  startsAt    DateTime     @map("starts_at")
  endsAt      DateTime?    @map("ends_at")
  location    String?      @db.VarChar(120)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  eventImages EventImage[]

  @@map("events")
}

model EventImage {
  id        String   @id @default(uuid())
  eventId   String   @map("event_id")
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  imagePath String   @map("image_path")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("event_images")
}
